version: "3.7"
services:
  traefik:
    image: traefik:v1.7.16
    command: [
      "--api",
      "--docker",
      "--docker.watch",
      "--docker.domain=smartnode.localhost",
    ]
    restart: always
    ports:
      - "9080:8080" # Web UI (enabled by --api)
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    networks:
      net:
        aliases:
          - "eth1.rpc.smartnode.localhost"
  pow:
    image: ${POW_IMAGE}
    restart: on-failure
    volumes:
      - eth1clientdata:/ethclient
      - ./setup/pow:/setup:ro
    networks:
      - net
    environment:
      - CLIENT=${POW_CLIENT}
      - NETWORKID=${POW_NETWORK_ID}
      - BOOTNODE=${POW_BOOTNODE}
      - ETHSTATSLABEL=${POW_ETHSTATS_LABEL}
      - ETHSTATSLOGIN=${POW_ETHSTATS_LOGIN}
    entrypoint: /setup/start.sh
    labels:
      - traefik.enable=true
      - traefik.port=8545
      - traefik.docker.network=${COMPOSE_PROJECT_NAME}_net
      - traefik.frontend.priority=10
      - traefik.frontend.rule=Host:eth1.rpc.smartnode.localhost
      - traefik.backend.loadbalancer.stickiness=true
      - traefik.backend.loadbalancer.stickiness.cookieName=smartnodeEth1
      - traefik.backend.loadbalancer.method=drr
      - traefik.backend=eth1.rpc.smartnode
    depends_on:
      - traefik
  cli:
    image: rocketpool/smartnode-cli:v0.0.1
    restart: on-failure
    volumes:
      - ${RP_PATH}:/.rocketpool
    networks:
      - net
    depends_on:
      - pow
    entrypoint: /bin/sh
    tty: true
  minipools:
    image: rocketpool/smartnode-minipools:v0.0.1
    restart: on-failure
    volumes:
      - ${RP_PATH}:/.rocketpool
      - /var/run/docker.sock:/var/run/docker.sock
    networks:
      - net
    command: [
      "${RP_PATH}",
      "rocketpool/smartnode-minipool:v0.0.1",
      "${COMPOSE_PROJECT_NAME}_minipool_",
      "${COMPOSE_PROJECT_NAME}_net",
    ]
    depends_on:
      - pow
  node:
    image: rocketpool/smartnode-node:v0.0.1
    restart: on-failure
    volumes:
      - ${RP_PATH}:/.rocketpool
    networks:
      - net
    depends_on:
      - pow
  watchtower:
    image: rocketpool/smartnode-watchtower:v0.0.1
    restart: on-failure
    volumes:
      - ${RP_PATH}:/.rocketpool
    networks:
      - net
    depends_on:
      - pow
networks:
  net:
volumes:
  eth1clientdata:
